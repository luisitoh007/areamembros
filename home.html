<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BlackMind Academy – Módulos</title>
  <link rel="stylesheet" href="style.css" />

  <!-- 1) Carrega o SDK compat do Firebase ANTES de qualquer script que o use -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js" defer></script>
</head>

<body>
  <!-- NavBar -->
  <nav class="nav-bar">
    <div class="logo">BlackMind Academy</div>
    <button id="btn-logout" class="btn-logout">Sair</button>
  </nav>

  <!-- Carrosséis de Módulos -->
  <main class="modules-container">
    <h1>Seus Módulos</h1>

    <!-- Linha 1 -->
    <div class="carousel-container">
      <button class="carousel-btn prev" data-row="1">‹</button>
      <div class="viewport" id="viewport-1">
        <div class="cards-grid" id="cards-row-1"></div>
      </div>
      <button class="carousel-btn next" data-row="1">›</button>
    </div>

    <!-- Linha 2 -->
    <div class="carousel-container">
      <button class="carousel-btn prev" data-row="2">‹</button>
      <div class="viewport" id="viewport-2">
        <div class="cards-grid" id="cards-row-2"></div>
      </div>
      <button class="carousel-btn next" data-row="2">›</button>
    </div>
  </main>

  <!-- Overlay de Detalhes do Módulo -->
  <div id="module-detail" class="module-detail hidden">
    <button class="back-btn" onclick="closeModule()">← Voltar</button>
    <h2 id="detail-title"></h2>
    <div class="progress-bar">
      <div id="progress-fill" class="progress-fill"></div>
    </div>
    <ul id="lesson-list" class="lesson-list"></ul>
  </div>

  <!-- 2) Seu código só deve rodar APÓS os SDKs terem carregado -->
  <script defer>
    // Inicialização do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBdndbvlBYTNY9pOdskuxYZFMtK1B84Q7U",
      authDomain: "black-mind-d6547.firebaseapp.com",
      projectId: "black-mind-d6547"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // Logout
    document.getElementById('btn-logout').addEventListener('click', () =>
      auth.signOut().then(() => window.location.href = 'index.html')
    );

    // Ao mudar de estado de autenticação, carrega módulos
    auth.onAuthStateChanged(user => {
      if (!user) return window.location.href = 'index.html';
      loadModules(user.uid);
    });

    async function loadModules(uid) {
      try {
        const modSnap  = await db.collection('modules').get();
        const progSnap = await db.collection('userProgress').doc(uid).get();
        const userProg = progSnap.exists ? progSnap.data().modules || {} : {};

        // Isto imprimiu os IDs dos módulos no console?
        console.log('Módulos carregados:', modSnap.docs.map(d => d.id));

        const modules = modSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderCarousels(modules, userProg);
      } catch (err) {
        console.error('Erro ao carregar módulos:', err);
        alert('Erro ao carregar módulos; veja console.');
      }
    }

    function renderCarousels(modules, userProg) {
      // Limpa containers
      const row1 = document.getElementById('cards-row-1');
      const row2 = document.getElementById('cards-row-2');
      row1.innerHTML = '';
      row2.innerHTML = '';

      modules.slice(0,5).forEach(mod => createCard(mod, row1, userProg));
      modules.slice(5).forEach(mod => createCard(mod, row2, userProg));

      // Scroll dos botões
      document.querySelectorAll('.carousel-btn').forEach(btn => {
        btn.onclick = () => {
          const row = btn.dataset.row;
          const vp  = document.getElementById(`viewport-${row}`);
          const shift = vp.clientWidth;
          vp.scrollBy({ left: btn.classList.contains('next') ? shift : -shift, behavior: 'smooth' });
        };
      });
    }

    function createCard(mod, container, userProg) {
      const completed = (userProg[mod.id]?.completedLessons) || [];
      const total     = Array.isArray(mod.lessons) ? mod.lessons.length : 1;
      const pct       = Math.round(completed.length / total * 100);

      const card = document.createElement('div');
      card.className = 'module-card';
      card.innerHTML = `
        <img src="${mod.thumb || 'https://via.placeholder.com/300x200?text=' + encodeURIComponent(mod.title)}" alt="${mod.title}">
        <div class="card-info">
          <h3>${mod.title}</h3>
          <div class="progress-bar">
            <div class="fill" style="width: ${pct}%"></div>
          </div>
        </div>
      `;

      card.onclick = () => openModule(mod, pct);
      container.appendChild(card);
    }

    function openModule(mod, pct) {
      document.getElementById('detail-title').innerText = mod.title;
      document.getElementById('progress-fill').style.width = pct + '%';

      const list = document.getElementById('lesson-list');
      list.innerHTML = '';
      (mod.lessons || []).forEach((ls, idx) => {
        const li = document.createElement('li');
        li.textContent = ls.title;
        li.onclick = () => window.location.href = `lesson.html?mod=${mod.id}&lesson=${idx}`;
        list.appendChild(li);
      });

      document.getElementById('module-detail').classList.remove('hidden');
    }

    function closeModule() {
      document.getElementById('module-detail').classList.add('hidden');
    }
  </script>
</body>
</html>
